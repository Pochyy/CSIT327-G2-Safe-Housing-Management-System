<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ property.property_name }} - Safe Haven</title>
    {% load static %}
    {% load custom_filters %}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'renterPage/renter.css' %}">
</head>
<body>
    <!-- Enhanced Header -->
    <div class="header-container">
        <div class="header-content">
            <div class="logo-section">
                <img src="{% static 'images/SH.png' %}" alt="Safe Haven Logo">
                <h2>Safe <span>Haven</span></h2>
            </div>

            <div class="user-info" id="userDropdownBtn">
                <div>{{ user.first_name }} {{ user.last_name }}</div>
                <div class="user-avatar">{{ user.first_name|first }}{{ user.last_name|first }}</div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item">
                        <i class="fas fa-user-circle"></i> My Profile
                    </div>
                    <div class="user-dropdown-item">
                        <i class="fas fa-heart"></i> Saved Properties
                    </div>
                    <div class="user-dropdown-item">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                    <div class="user-dropdown-divider"></div>
                    <div class="user-dropdown-item" id="logoutBtn">
                        <form action="{% url 'users:logout' %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" style="background: none; border: none; color: inherit; cursor: pointer; width: 100%; text-align: left;">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Details Content -->
    <div class="property-details-container">
        <a href="{% url 'renter:home' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Properties
        </a>
        
        <div class="property-details-grid">
            <!-- LEFT COLUMN: Property Image + Comments -->
            <div>
                <!-- Property Images Section -->
                <div class="property-images">
                    {% if property.image %}
                        <img src="{{ property.image.url }}" 
                             alt="{{ property.property_name }}" 
                             class="property-image-large"
                             onerror="this.style.display='none'; document.getElementById('image-placeholder').style.display='flex';"
                             id="main-property-image">
                    {% endif %}
                    
                    <div class="image-placeholder" id="image-placeholder" {% if property.image %}style="display: none;"{% endif %}>
                        <div class="text-center">
                            <i class="fas fa-home fa-3x mb-3" style="color: #9ca3af;"></i>
                            <div>Property Image</div>
                            <div class="text-sm" style="color: #6b7280;">Image preview available soon</div>
                        </div>
                    </div>
                </div>
                
                <!-- COMMENT SECTION -->
                <div class="comments-section">
                    <div class="comments-header">
                        <div class="comments-title">
                            <i class="fas fa-comments"></i>
                            <span>Tenant Reviews</span>
                        </div>
                        <div class="comments-count" id="commentsCount">
                            {{ comments|length }} comment{{ comments|length|pluralize }}
                        </div>
                    </div>

                    <!-- Comment Form (for renters only) -->
                    {% if user.is_authenticated and user.user_role == 'renter' %}
                    <div class="comment-form-container fade-in">
                        <div class="comment-form-title">
                            <i class="fas fa-edit"></i>
                            <span>Add Your Review</span>
                        </div>
                        <form id="commentForm" method="POST" action="{% url 'renter:add_comment' property.id %}">
                            {% csrf_token %}
                            <div class="star-rating">
                                <i class="fa-regular fa-star" data-value="1"></i>
                                <i class="fa-regular fa-star" data-value="2"></i>
                                <i class="fa-regular fa-star" data-value="3"></i>
                                <i class="fa-regular fa-star" data-value="4"></i>
                                <i class="fa-regular fa-star" data-value="5"></i>
                            </div>

                            <input type="hidden" name="rating" id="ratingValue">

                            <textarea 
                                class="comment-input" 
                                name="comment_content" 
                                placeholder="Share your experience with this property..."
                                required></textarea>
                            <button type="submit" class="comment-submit-btn">
                                <i class="fas fa-paper-plane"></i>
                                Post Comment
                            </button>
                            <div style="clear: both;"></div>
                        </form>
                    </div>
                    {% elif user.is_authenticated and user.user_role == 'landlord' %}
                    <!-- No comment form for landlords -->
                    {% else %}
                    <!-- Users must be logged in to comment -->
                    {% endif %}

                    <!-- Comments List with Scroll -->
                    <div class="comments-list" id="commentsList">
                        {% if comments %}
                            {% for comment in comments %}
                            <div class="comment-item fade-in" id="comment-{{ comment.id }}">
                                <div class="comment-header">
                                    <div class="comment-avatar">
                                        {{ comment.user.first_name|first|upper }}{{ comment.user.last_name|first|upper }}
                                    </div>
                                    <div class="comment-user-info">
                                        <div class="comment-user-name">
                                            {{ comment.user.first_name }} {{ comment.user.last_name }}
                                            <span style="color: #6B7280; font-weight: normal; font-size: 0.75rem;">
                                                ({% if comment.user.user_role == 'renter' %}Tenant{% else %}{{ comment.user.user_role|title }}{% endif %})
                                            </span>
                                        </div>
                                        <div class="comment-timestamp">
                                            {{ comment.created_at|date:"M d, Y · h:i A" }}
                                        </div>
                                    </div>
                                </div>

                                 <div class="comment-rating" style="margin: 4px 0;">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= comment.rating %}
                                            <i class="fa-solid fa-star" style="color: #fbbf24;"></i>
                                        {% else %}
                                            <i class="fa-regular fa-star" style="color: #d1d5db;"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                
                                <div class="comment-content">
                                    {{ comment.content|linebreaks }}
                                </div>

                                <!-- Reply Button (for landlords only) -->
                                {% if user.is_authenticated and user.user_role == 'landlord' %}
                                <button class="reply-btn" onclick="toggleReplyForm('{{ comment.id }}')">
                                    <i class="fas fa-reply"></i>
                                    Reply
                                </button>
                                {% endif %}

                                <!-- Reply Form (initially hidden - only for landlords) -->
                                {% if user.is_authenticated and user.user_role == 'landlord' %}
                                <div class="reply-form" id="replyForm-{{ comment.id }}">
                                    <form method="POST" action="{% url 'renter:add_reply' comment.id %}">
                                        {% csrf_token %}
                                        <textarea 
                                            class="reply-input" 
                                            name="reply_content" 
                                            placeholder="Write your reply as the landlord..."
                                            required></textarea>
                                        <div class="reply-actions">
                                            <button type="button" class="reply-cancel-btn" onclick="toggleReplyForm('{{ comment.id }}')">
                                                Cancel
                                            </button>
                                            <button type="submit" class="reply-submit-btn">
                                                <i class="fas fa-paper-plane"></i>
                                                Post Reply
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                {% endif %}

                                <!-- Replies List -->
                                {% if comment.replies.all %}
                                <div class="replies-list">
                                    {% for reply in comment.replies.all %}
                                    <div class="reply-item fade-in">
                                        <div class="reply-header">
                                            <div class="reply-avatar">
                                                {{ reply.user.first_name|first|upper }}{{ reply.user.last_name|first|upper }}
                                            </div>
                                            <div class="reply-user-name">
                                                {{ reply.user.first_name }} {{ reply.user.last_name }}
                                                <span style="color: #6B7280; font-weight: normal; font-size: 0.625rem;">
                                                    (Landlord)
                                                </span>
                                            </div>
                                            <div class="reply-timestamp">
                                                {{ reply.created_at|timesince }} ago
                                            </div>
                                        </div>
                                        <div class="reply-content">
                                            {{ reply.content|linebreaks }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Empty State -->
                            <div class="comments-empty">
                                <i class="fas fa-comment-slash"></i>
                                <h4>No comments yet</h4>
                                <p>Be the first tenant to share your experience with this property!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- RIGHT COLUMN: Property Info -->
            <div class="property-info">
                <h1 class="property-title-large">{{ property.property_name }}</h1>
                <div class="property-price-large">₱{{ property.price|intcomma }}/month</div>

                <!-- Average Rating -->
                <div class="property-overall-rating" style="margin: 8px 0;">
                    <span class="rating-stars">
                        {% for i in "12345" %}
                            {% if forloop.counter <= avg_rating|floatformat:0 %}
                                <i class="fa-solid fa-star" style="color: #fbbf24;"></i>
                            {% elif forloop.counter <= avg_rating %}
                                <i class="fa-solid fa-star-half-stroke" style="color: #fbbf24;"></i>
                            {% else %}
                                <i class="fa-regular fa-star" style="color: #d1d5db;"></i>
                            {% endif %}
                        {% endfor %}
                    </span>
                    <span class="rating-value" style="margin-left: 6px; font-weight: 500;">
                        {{ avg_rating|floatformat:1 }}/5
                    </span>
                    <span class="rating-count" style="color: #6b7280; font-size: 0.875rem; margin-left: 6px;">
                        ({{ comments|length }} review{{ comments|length|pluralize }})
                    </span>
                </div>

                
                <div class="property-location-large">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ property.location }}</span>
                </div>
                
                <div class="property-features-large">
                    <div class="feature-item">
                        <div class="feature-value">{{ property.beds }}</div>
                        <div class="feature-label">
                            <i class="fas fa-bed"></i> Bedroom{{ property.beds|pluralize }}
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-value">{{ property.bathrooms }}</div>
                        <div class="feature-label">
                            <i class="fas fa-bath"></i> Bathroom{{ property.bathrooms|pluralize }}
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-value">{{ property.area }}</div>
                        <div class="feature-label">
                            <i class="fas fa-vector-square"></i> Sq Ft
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-file-alt"></i> Description
                </h3>
                <p class="description-text">{{ property.property_description|default:"No description provided for this property." }}</p>
                
                <h3 class="section-title">
                    <i class="fas fa-star"></i> Amenities & Features
                </h3>
                <div class="amenities-grid">
                    {% if property.electricity %}<div class="amenity-item"><i class="fas fa-bolt amenity-icon"></i> <span>Electricity</span></div>{% endif %}
                    {% if property.water %}<div class="amenity-item"><i class="fas fa-tint amenity-icon"></i> <span>Water Supply</span></div>{% endif %}
                    {% if property.internet %}<div class="amenity-item"><i class="fas fa-wifi amenity-icon"></i> <span>Internet/Wi-Fi</span></div>{% endif %}
                    {% if property.airconditioning %}<div class="amenity-item"><i class="fas fa-wind amenity-icon"></i> <span>Air Conditioning</span></div>{% endif %}
                    {% if property.kitchen %}<div class="amenity-item"><i class="fas fa-utensils amenity-icon"></i> <span>Kitchen</span></div>{% endif %}
                    {% if property.shared_kitchen %}<div class="amenity-item"><i class="fas fa-utensil-spoon amenity-icon"></i> <span>Shared Kitchen</span></div>{% endif %}
                    {% if property.private_bathroom %}<div class="amenity-item"><i class="fas fa-bath amenity-icon"></i> <span>Private Bathroom</span></div>{% endif %}
                    {% if property.shared_bathroom %}<div class="amenity-item"><i class="fas fa-restroom amenity-icon"></i> <span>Shared Bathroom</span></div>{% endif %}
                    {% if property.parking %}<div class="amenity-item"><i class="fas fa-parking amenity-icon"></i> <span>Parking</span></div>{% endif %}
                    {% if property.furnished %}<div class="amenity-item"><i class="fas fa-couch amenity-icon"></i> <span>Furnished</span></div>{% endif %}
                    {% if property.pet_friendly %}<div class="amenity-item"><i class="fas fa-paw amenity-icon"></i> <span>Pet Friendly</span></div>{% endif %}
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-shield-alt"></i> Safety & Security
                </h3>
                <div class="amenities-grid">
                    {% if property.secure_locks %}<div class="amenity-item"><i class="fas fa-lock amenity-icon"></i> <span>Secure Locks</span></div>{% endif %}
                    {% if property.cctv %}<div class="amenity-item"><i class="fas fa-video amenity-icon"></i> <span>CCTV Surveillance</span></div>{% endif %}
                    {% if property.gated_compound %}<div class="amenity-item"><i class="fas fa-door-closed amenity-icon"></i> <span>Gated Compound</span></div>{% endif %}
                    {% if property.security_guard %}<div class="amenity-item"><i class="fas fa-user-shield amenity-icon"></i> <span>Security Guard</span></div>{% endif %}
                </div>
                
                <div class="action-buttons">
                    <button class="btn-contact" onclick="contactLandlord()">
                        <i class="fas fa-envelope"></i> Contact Information
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Landlord Modal -->
    <div class="contact-modal-overlay" id="contactModalOverlay">
        <div class="contact-modal">
            <button class="close-modal" onclick="closeContactModal()">×</button>
            
            <div class="contact-modal-header">
                <i class="fas fa-phone-alt" style="color: #2C6E6F;"></i>
                <h3>Contact Information</h3>
            </div>
            
            <div class="contact-info">
                <div class="contact-item">
                    <i class="fas fa-home"></i>
                    <span class="contact-label">PROPERTY:</span>
                    <span class="contact-value">{{ property.property_name }}</span>
                </div>
                
                <div class="contact-item">
                    <i class="fas fa-user"></i>
                    <span class="contact-label">LANDLORD:</span>
                    <span class="contact-value">{{ landlord_name }}</span>
                </div>
                
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <span class="contact-label">CONTACT:</span>
                    <span class="contact-value">{{ landlord_phone|default:"Not provided" }}</span>
                </div>
                
                <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <span class="contact-label">EMAIL:</span>
                    <span class="contact-value">{{ landlord_email }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JavaScript -->
    <script src="{% static 'renterPage/renter.js' %}"></script>
</body>
</html>